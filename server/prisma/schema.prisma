// Prisma Schema for Check Printing System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Branches Table
model Branch {
  id             Int      @id @default(autoincrement())
  branchName     String   @map("branch_name")
  branchLocation String   @map("branch_location")
  routingNumber  String   @unique @map("routing_number")
  branchNumber   String   @map("branch_number") @default("")
  accountingNumber String @map("accounting_number") @default("")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  users           User[]
  accounts        Account[]
  printOperations PrintOperation[]

  @@map("branches")
}

// Permissions Table
model Permission {
  id             Int      @id @default(autoincrement())
  permissionName String   @unique @map("permission_name")
  permissionCode String   @unique @map("permission_code")
  description    String?
  createdAt      DateTime @default(now()) @map("created_at")

  userPermissions UserPermission[]

  @@map("permissions")
}

// Users Table
model User {
  id           Int      @id @default(autoincrement())
  username     String   @unique
  passwordHash String   @map("password_hash")
  branchId     Int?     @map("branch_id")
  isAdmin      Boolean  @default(false) @map("is_admin")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  branch                Branch?                @relation(fields: [branchId], references: [id], onDelete: SetNull)
  userPermissions       UserPermission[]
  inventoryTransactions InventoryTransaction[]
  printOperations       PrintOperation[]
  printLogs             PrintLog[]

  @@map("users")
}

// User Permissions Junction Table
model UserPermission {
  userId       Int      @map("user_id")
  permissionId Int      @map("permission_id")
  grantedAt    DateTime @default(now()) @map("granted_at")

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([userId, permissionId])
  @@map("user_permissions")
}

// Accounts Table
model Account {
  id                Int      @id @default(autoincrement())
  accountNumber     String   @unique @map("account_number")
  accountHolderName String   @map("account_holder_name")
  accountType       Int      @map("account_type") // 1: Individual, 2: Corporate
  branchId          Int?     @map("branch_id")
  branch            Branch?  @relation(fields: [branchId], references: [id], onDelete: SetNull)
  lastPrintedSerial Int      @default(0) @map("last_printed_serial")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  printOperations PrintOperation[]

  @@map("accounts")
}

// Inventory Table
model Inventory {
  id        Int      @id @default(autoincrement())
  stockType Int      @map("stock_type") // 1: Individual (25 sheets), 2: Corporate (50 sheets)
  quantity  Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("inventory")
}

// Inventory Transactions Table
model InventoryTransaction {
  id              Int      @id @default(autoincrement())
  stockType       Int      @map("stock_type")
  transactionType String   @map("transaction_type") // ADD, DEDUCT
  quantity        Int
  serialFrom      String?  @map("serial_from")
  serialTo        String?  @map("serial_to")
  userId          Int?     @map("user_id")
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("inventory_transactions")
}

// Print Operations Table
model PrintOperation {
  id            Int      @id @default(autoincrement())
  accountId     Int      @map("account_id")
  userId        Int?     @map("user_id")
  branchId      Int?     @map("branch_id")
  routingNumber String   @map("routing_number")
  accountNumber String   @map("account_number")
  accountType   Int      @map("account_type")
  serialFrom    Int      @map("serial_from")
  serialTo      Int      @map("serial_to")
  sheetsPrinted Int      @map("sheets_printed")
  printDate     DateTime @default(now()) @map("print_date")
  status        String   @default("COMPLETED") // PENDING, COMPLETED, FAILED
  notes         String?
  pdfFilename   String?  @map("pdf_filename")

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  user    User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  branch  Branch? @relation(fields: [branchId], references: [id], onDelete: SetNull)

  @@map("print_operations")
}

// Print Settings Table
model PrintSettings {
  id          Int   @id @default(autoincrement())
  accountType Int   @map("account_type") // 1: Individual, 2: Corporate
  checkWidth  Float @map("check_width") // mm
  checkHeight Float @map("check_height") // mm

  // Branch Name Position
  branchNameX        Float  @map("branch_name_x")
  branchNameY        Float  @map("branch_name_y")
  branchNameFontSize Int    @default(14) @map("branch_name_font_size")
  branchNameAlign    String @default("center") @map("branch_name_align")

  // Serial Number Position
  serialNumberX        Float  @map("serial_number_x")
  serialNumberY        Float  @map("serial_number_y")
  serialNumberFontSize Int    @default(12) @map("serial_number_font_size")
  serialNumberAlign    String @default("right") @map("serial_number_align")

  // Account Holder Name Position
  accountHolderNameX        Float  @map("account_holder_name_x")
  accountHolderNameY        Float  @map("account_holder_name_y")
  accountHolderNameFontSize Int    @default(10) @map("account_holder_name_font_size")
  accountHolderNameAlign    String @default("left") @map("account_holder_name_align")

  // MICR Line Position
  micrLineX        Float  @map("micr_line_x")
  micrLineY        Float  @map("micr_line_y")
  micrLineFontSize Int    @default(12) @map("micr_line_font_size")
  micrLineAlign    String @default("center") @map("micr_line_align")

  // Account Number Position
  accountNumberX        Float?  @map("account_number_x")
  accountNumberY        Float?  @map("account_number_y")
  accountNumberFontSize Int?    @default(12) @map("account_number_font_size")
  accountNumberAlign    String? @default("left") @map("account_number_align")

  // Check Sequence Position
  checkSequenceX        Float?  @map("check_sequence_x")
  checkSequenceY        Float?  @map("check_sequence_y")
  checkSequenceFontSize Int?    @default(12) @map("check_sequence_font_size")
  checkSequenceAlign    String? @default("left") @map("check_sequence_align")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([accountType])
  @@map("print_settings")
}

// System Settings Table
model SystemSetting {
  key       String   @id @map("setting_key")
  value     String   @map("setting_value")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

// Print Logs Table
model PrintLog {
  id                Int      @id @default(autoincrement())
  accountNumber     String   @map("account_number")
  accountBranch     String   @map("account_branch")
  branchName        String?  @map("branch_name")
  firstChequeNumber Int      @map("first_cheque_number")
  lastChequeNumber  Int      @map("last_cheque_number")
  totalCheques      Int      @map("total_cheques")
  accountType       Int      @map("account_type")
  operationType     String   @map("operation_type") // 'print' or 'reprint'
  printedBy         Int      @map("printed_by")
  printedByName     String   @map("printed_by_name")
  printDate         DateTime @default(now()) @map("print_date")
  notes             String?
  
  user User @relation(fields: [printedBy], references: [id])

  @@index([accountNumber])
  @@index([printDate])
  @@index([operationType])
  @@map("print_logs")
}

// Printed Cheques Tracking Table
model PrintedCheque {
  id            Int      @id @default(autoincrement())
  accountNumber String   @map("account_number")
  chequeNumber  Int      @map("cheque_number")
  printLogId    Int      @map("print_log_id")
  printDate     DateTime @default(now()) @map("print_date")
  canReprint    Boolean  @default(false) @map("can_reprint")

  @@unique([accountNumber, chequeNumber])
  @@index([accountNumber])
  @@map("printed_cheques")
}
