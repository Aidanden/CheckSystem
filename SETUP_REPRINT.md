# خطوات تفعيل ميزة إعادة الطباعة

## الخطوة 1: تحديث قاعدة البيانات

قم بتشغيل السكريبت التالي لإضافة صلاحية إعادة الطباعة:

```bash
# الاتصال بقاعدة البيانات
psql -U postgres -d check_printing_db

# تشغيل السكريبت
\i server/src/database/add_reprint_permission.sql

# أو يمكنك تشغيل الأمر مباشرة:
INSERT INTO permissions (permission_name, permission_code, description)
SELECT 'إعادة الطباعة', 'REPRINT', 'السماح للمستخدم بإعادة طباعة الشيكات المطبوعة مسبقاً من شاشة السجلات'
WHERE NOT EXISTS (
    SELECT 1 FROM permissions WHERE permission_code = 'REPRINT'
);
```

## الخطوة 2: منح الصلاحية للمستخدمين

### الطريقة الأولى: من خلال الواجهة (موصى بها)
1. سجل دخول كمسؤول (Admin)
2. انتقل إلى شاشة **"إدارة المستخدمين"**
3. اضغط على زر **"تعديل"** (✏️) للمستخدم المطلوب
4. في قسم **"الصلاحيات"**، ستجد قائمة بجميع الصلاحيات المتاحة
5. ضع علامة ✓ على **"إعادة الطباعة"**
6. اضغط على **"حفظ"**

**ملاحظة:** الصلاحية ستظهر تلقائياً في القائمة بعد تشغيل سكريبت SQL في الخطوة 1.

### الطريقة الثانية: من خلال SQL مباشرة
```sql
-- منح صلاحية إعادة الطباعة لمستخدم معين
INSERT INTO user_permissions (user_id, permission_id)
SELECT 
    u.id,
    p.id
FROM users u
CROSS JOIN permissions p
WHERE u.username = 'اسم_المستخدم'  -- استبدل باسم المستخدم المطلوب
  AND p.permission_code = 'REPRINT'
  AND NOT EXISTS (
    SELECT 1 FROM user_permissions up 
    WHERE up.user_id = u.id AND up.permission_id = p.id
  );
```

### الطريقة الثالثة: منح الصلاحية لجميع المدراء
```sql
-- منح الصلاحية لجميع المدراء تلقائياً
INSERT INTO user_permissions (user_id, permission_id)
SELECT 
    u.id,
    p.id
FROM users u
CROSS JOIN permissions p
WHERE u.is_admin = true
  AND p.permission_code = 'REPRINT'
  AND NOT EXISTS (
    SELECT 1 FROM user_permissions up 
    WHERE up.user_id = u.id AND up.permission_id = p.id
  );
```

## الخطوة 3: إعادة تشغيل التطبيق

```bash
# إعادة تشغيل الخادم
cd server
npm run dev

# إعادة تشغيل العميل (في نافذة أخرى)
cd client
npm run dev
```

## الخطوة 4: الاختبار

1. **اختبار الطباعة الأولى:**
   - انتقل إلى شاشة "طباعة شيك جديد"
   - استعلم عن حساب
   - اطبع الدفتر
   - تحقق من ظهور السجل في "سجلات الطباعة"

2. **اختبار منع الطباعة المتكررة:**
   - حاول طباعة نفس الحساب مرة أخرى
   - يجب أن تظهر رسالة تحذير
   - يجب أن يتم منع الطباعة

3. **اختبار إعادة الطباعة:**
   - انتقل إلى "سجلات الطباعة"
   - اضغط على زر "إعادة طباعة" لأي سجل
   - يجب أن تفتح نافذة الطباعة
   - تحقق من تسجيل عملية إعادة الطباعة

4. **اختبار الصلاحيات:**
   - سجل دخول بمستخدم بدون صلاحية REPRINT
   - يجب أن تظهر رسالة تنبيه في شاشة السجلات
   - يجب ألا يظهر زر "إعادة طباعة"

## ملاحظات مهمة

- ✅ المدراء (isAdmin = true) لديهم صلاحية إعادة الطباعة تلقائياً
- ✅ يتم تسجيل كل عملية إعادة طباعة بشكل منفصل
- ✅ لا يمكن طباعة نفس الدفتر مرتين من شاشة الطباعة العادية
- ⚠️ إعادة الطباعة تتطلب اتصال نشط بـ SOAP API

## استكشاف الأخطاء

### المشكلة: لا يظهر زر إعادة الطباعة
**الحل:** تأكد من أن المستخدم لديه صلاحية REPRINT أو أنه مسؤول

### المشكلة: فشل إعادة الطباعة
**الحل:** 
1. تحقق من اتصال SOAP API
2. تحقق من وجود البيانات في قاعدة البيانات
3. راجع سجلات الأخطاء في Console

### المشكلة: لا يتم تسجيل العملية
**الحل:**
1. تحقق من اتصال قاعدة البيانات
2. تحقق من صلاحيات المستخدم في قاعدة البيانات
3. راجع سجلات الخادم

## الدعم الفني

للمساعدة:
- الشركة: M.T.C
- الهاتف: 0925232731 / 0915730097
