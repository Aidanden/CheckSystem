# التحقق من صلاحية الفرع - Branch Validation

## التاريخ: 2025-12-03

## نظرة عامة

تم إضافة ميزة التحقق من صلاحية الفرع لضمان أن المستخدمين يمكنهم فقط الاستعلام عن حسابات فرعهم.

---

## كيف يعمل النظام

### 1. **استخراج رقم الفرع من رقم الحساب**

رقم الحساب المصرفي يتكون من 15 رقماً، وأول 3 أرقام تمثل رقم الفرع:

```
001001000100001
^^^
رقم الفرع (001 = طرابلس)

002001000200001
^^^
رقم الفرع (002 = مصراته)
```

### 2. **التحقق قبل الاستعلام**

عند محاولة الاستعلام عن حساب:

1. **استخراج رقم الفرع** من أول 3 أرقام من رقم الحساب
2. **مقارنة** مع رقم فرع المستخدم الحالي
3. **السماح أو المنع** بناءً على التطابق

### 3. **الاستثناءات**

- **المدير (Admin)**: يمكنه الاستعلام عن أي حساب من أي فرع
- **المستخدمون العاديون**: مقيدون بحسابات فرعهم فقط

---

## التطبيق التقني

### في Backend (JWT Token)

تم تحديث `auth.service.ts` لإضافة `branchNumber` إلى الـ JWT token:

```typescript
const token = jwt.sign(
  {
    userId: user.id,
    username: user.username,
    isAdmin: user.isAdmin,
    branchId: user.branchId,
    branchNumber: userWithDetails.branch?.branchNumber, // ✅ جديد
  },
  this.JWT_SECRET,
  { expiresIn: this.JWT_EXPIRES_IN }
);
```

### في Frontend (Print Page)

تم تحديث `print/page.tsx` لإضافة فحص الفرع:

```typescript
// فك تشفير الـ token
const token = localStorage.getItem('token');
const payload = JSON.parse(atob(token.split('.')[1]));
const currentUser = payload;

// التحقق من رقم الفرع
if (!currentUser.isAdmin && currentUser.branchNumber) {
  const accountBranchCode = accountNumber.substring(0, 3);
  
  if (accountBranchCode !== currentUser.branchNumber) {
    setError(`❌ هذا الحساب تابع لفرع آخر (${accountBranchCode}). 
              أنت مخول فقط للاستعلام عن حسابات فرع ${currentUser.branchNumber}.`);
    return;
  }
}
```

---

## أمثلة الاستخدام

### مثال 1: مستخدم فرع طرابلس (001)

**السيناريو:**
- المستخدم: `trip_operator`
- الفرع: طرابلس (001)
- رقم الحساب المدخل: `001001000100001`

**النتيجة:**
✅ **نجح** - أول 3 أرقام (001) تطابق رقم فرع المستخدم

---

### مثال 2: محاولة الوصول لفرع آخر

**السيناريو:**
- المستخدم: `trip_operator`
- الفرع: طرابلس (001)
- رقم الحساب المدخل: `002001000200001`

**النتيجة:**
❌ **فشل** - رسالة خطأ:
```
❌ هذا الحساب تابع لفرع آخر (002). 
   أنت مخول فقط للاستعلام عن حسابات فرع 001.
```

---

### مثال 3: المدير

**السيناريو:**
- المستخدم: `admin`
- الفرع: طرابلس (001)
- رقم الحساب المدخل: `002001000200001`

**النتيجة:**
✅ **نجح** - المدير يمكنه الوصول لجميع الفروع

---

## الملفات المعدلة

### Backend:
- `server/src/services/auth.service.ts` - إضافة `branchNumber` للـ token

### Frontend:
- `client/src/app/print/page.tsx` - إضافة فحص الفرع قبل الاستعلام

---

## الفوائد الأمنية

1. **فصل البيانات**: كل فرع يرى فقط بياناته
2. **منع الأخطاء**: تجنب طباعة شيكات لحسابات فروع أخرى
3. **التدقيق**: سهولة تتبع من استعلم عن ماذا
4. **الامتثال**: يتوافق مع سياسات الأمان المصرفية

---

## ملاحظات مهمة

### 1. **إعادة تسجيل الدخول مطلوبة**

بعد تطبيق هذا التحديث، يجب على المستخدمين **إعادة تسجيل الدخول** للحصول على token جديد يحتوي على `branchNumber`.

### 2. **تنسيق رقم الحساب**

يجب أن يكون رقم الحساب **15 رقماً** وأن تكون أول 3 أرقام هي رقم الفرع.

### 3. **إضافة رقم الفرع في قاعدة البيانات**

تأكد من أن جميع الفروع في قاعدة البيانات لديها `branchNumber` محدد:

```sql
-- التحقق من الفروع
SELECT id, branch_name, branch_number FROM branches;

-- تحديث رقم الفرع إذا كان فارغاً
UPDATE branches SET branch_number = '001' WHERE id = 1;
UPDATE branches SET branch_number = '002' WHERE id = 2;
```

---

## الاختبار

### 1. تسجيل الدخول كمستخدم فرع

```bash
# مستخدم طرابلس
Username: trip_operator
Password: 123
```

### 2. محاولة الاستعلام

```
رقم حساب طرابلس: 001001000100001 ✅ يعمل
رقم حساب مصراته: 002001000200001 ❌ يُرفض
```

### 3. تسجيل الدخول كمدير

```bash
Username: admin
Password: admin123
```

```
رقم حساب طرابلس: 001001000100001 ✅ يعمل
رقم حساب مصراته: 002001000200001 ✅ يعمل
```

---

## الخطوات التالية (اختياري)

### 1. إضافة الفحص في Backend أيضاً

يمكن إضافة نفس الفحص في الـ API endpoint للمزيد من الأمان:

```typescript
// في SOAP controller
if (!req.user.isAdmin && req.user.branchNumber) {
  const accountBranchCode = accountNumber.substring(0, 3);
  if (accountBranchCode !== req.user.branchNumber) {
    return res.status(403).json({ 
      error: 'غير مصرح لك بالوصول لحسابات هذا الفرع' 
    });
  }
}
```

### 2. إضافة الفحص في شاشات أخرى

يمكن تطبيق نفس المنطق في:
- شاشة سجلات الطباعة
- شاشة التقارير
- أي شاشة تعرض بيانات حسابات

---

## الخلاصة

✅ **تم تطبيق نظام فحص الفرع بنجاح**
- المستخدمون العاديون: مقيدون بفرعهم
- المدير: وصول كامل
- الفحص يتم **قبل** الاستعلام من SOAP API
- رسائل خطأ واضحة ومفيدة
