# ميزة إعادة الطباعة - Check Printing System

## نظرة عامة
تم تنفيذ ميزة إعادة الطباعة الكاملة في نظام طباعة الشيكات، والتي تسمح للمستخدمين المصرح لهم بإعادة طباعة دفاتر الشيكات المطبوعة مسبقاً من خلال شاشة سجلات الطباعة.

## المتطلبات المنفذة

### 1. ✅ تسجيل عمليات الطباعة
- عند طباعة دفتر شيكات من شاشة الطباعة، يتم تسجيل العملية تلقائياً في قاعدة البيانات
- يتم حفظ جميع تفاصيل العملية: رقم الحساب، نطاق الشيكات، المستخدم، التاريخ، إلخ
- يتم تسجيل أرقام الشيكات الفردية في جدول `printed_cheques`

### 2. ✅ منع الطباعة المتكررة
- عند الاستعلام عن حساب في شاشة الطباعة، يتم التحقق من الشيكات المطبوعة مسبقاً
- إذا كانت هناك شيكات مطبوعة، يتم عرض تحذير ومنع الطباعة
- رسالة التحذير: "⚠️ تحذير: بعض الشيكات تم طباعتها مسبقاً. لا يمكن طباعتها مرة أخرى إلا من شاشة السجلات."

### 3. ✅ إعادة الطباعة من شاشة السجلات
- تم إضافة زر "إعادة طباعة" في شاشة سجلات الطباعة
- عند الضغط على الزر:
  1. يتم جلب البيانات من SOAP API
  2. يتم جلب إعدادات الطباعة المناسبة
  3. يتم بناء معاينة الطباعة
  4. يتم فتح نافذة الطباعة
  5. يتم تسجيل العملية كـ "إعادة طباعة" في قاعدة البيانات

### 4. ✅ نظام الصلاحيات
- تم إضافة صلاحية جديدة: **"إعادة الطباعة" (REPRINT)**
- فقط المستخدمون الذين لديهم هذه الصلاحية أو المدراء يمكنهم إعادة الطباعة
- يتم عرض رسالة تنبيه للمستخدمين غير المصرح لهم

## الملفات المعدلة

### 1. قاعدة البيانات
- **`server/src/database/schema.sql`**: إضافة صلاحية REPRINT
- **`server/src/database/add_reprint_permission.sql`**: سكريبت لإضافة الصلاحية

### 2. الواجهة الأمامية (Client)
- **`client/src/app/print-logs/page.tsx`**: إعادة كتابة كاملة مع وظيفة إعادة الطباعة
- **`client/src/app/print/page.tsx`**: التحقق من الشيكات المطبوعة ومنع الطباعة المتكررة

### 3. الخادم (Server)
- **`server/src/models/PrintLog.model.ts`**: نموذج سجلات الطباعة (موجود مسبقاً)
- **`client/src/lib/api/services/printLog.service.ts`**: خدمات API (موجود مسبقاً)

## كيفية الاستخدام

### للمسؤول (Admin)
1. **منح صلاحية إعادة الطباعة:**
   - انتقل إلى شاشة إدارة المستخدمين
   - اختر المستخدم المطلوب
   - فعّل صلاحية "إعادة الطباعة"

2. **تشغيل سكريبت SQL:**
   ```bash
   # الاتصال بقاعدة البيانات
   psql -U postgres -d check_printing_db
   
   # تشغيل السكريبت
   \i server/src/database/add_reprint_permission.sql
   ```

### للمستخدم
1. **إعادة طباعة دفتر شيكات:**
   - انتقل إلى شاشة "سجلات الطباعة"
   - ابحث عن السجل المطلوب
   - اضغط على زر "إعادة طباعة"
   - تأكيد العملية
   - سيتم فتح نافذة الطباعة تلقائياً

## الأمان والتحكم

### التحقق من الصلاحيات
```typescript
const canReprint = currentUser?.isAdmin || 
  currentUser?.permissions?.some(p => p.permissionCode === 'REPRINT');
```

### تسجيل العمليات
- كل عملية إعادة طباعة يتم تسجيلها بشكل منفصل
- نوع العملية: `'reprint'` (بدلاً من `'print'`)
- يمكن تتبع من قام بإعادة الطباعة ومتى

### منع إساءة الاستخدام
- لا يمكن إعادة الطباعة إلا من خلال شاشة السجلات
- يتطلب تأكيد من المستخدم قبل كل عملية
- يتم تسجيل جميع العمليات للمراجعة

## الفوائد

1. **الأمان:** منع الطباعة المتكررة غير المصرح بها
2. **المرونة:** إمكانية إعادة الطباعة عند الحاجة
3. **التتبع:** سجل كامل لجميع عمليات الطباعة وإعادة الطباعة
4. **التحكم:** نظام صلاحيات دقيق

## ملاحظات مهمة

- ⚠️ يجب تشغيل سكريبت SQL لإضافة الصلاحية الجديدة
- ⚠️ يجب منح الصلاحية للمستخدمين المناسبين
- ⚠️ إعادة الطباعة تتطلب اتصال بـ SOAP API
- ✅ جميع العمليات يتم تسجيلها للمراجعة

## الاختبار

### سيناريو 1: طباعة جديدة
1. استعلم عن حساب لم يتم طباعته من قبل
2. اطبع الدفتر
3. تحقق من تسجيل العملية في السجلات

### سيناريو 2: منع الطباعة المتكررة
1. حاول طباعة نفس الحساب مرة أخرى
2. يجب أن تظهر رسالة تحذير
3. يجب أن يتم منع الطباعة

### سيناريو 3: إعادة الطباعة
1. انتقل إلى شاشة السجلات
2. اضغط على "إعادة طباعة" لسجل موجود
3. تحقق من فتح نافذة الطباعة
4. تحقق من تسجيل عملية إعادة الطباعة

### سيناريو 4: الصلاحيات
1. سجل دخول بمستخدم بدون صلاحية REPRINT
2. يجب أن تظهر رسالة تنبيه
3. يجب أن يكون زر إعادة الطباعة مخفياً

## الدعم الفني

للمساعدة أو الاستفسارات:
- الشركة المطورة: M.T.C
- الهاتف: 0925232731 / 0915730097
